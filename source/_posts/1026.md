title: 动态请/批假 - 引用审批模板
date: 2017/10/26
comments: true
tags:
 - 请假
 - 审批
 - 模板
categories:
 - 开发
----------

![我操你们大爷](http://oih7sazbd.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171026105607.jpg)
<!-- more -->

## IDE：
  >**[Atom](https://atom.io/)**

  >**[fiddler4](https://www.telerik.com/download/fiddler/fiddler4)**

  >**[MyEclipse](http://www.myeclipsecn.com/)**

## 浏览器
  >**[chrome](http://www.google.cn/chrome/browser/desktop/index.html)**

## 步骤记录
### 抓包
  1. 在dos命令中输入ipconfig,获取本机IP(此处以windows为例)
  ![](http://oih7sazbd.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20171026110329.png)

  2. 手机连接WIFI(此处以iPhone为例),配置手动代理,服务器地址为本机IP,端口8888,配置完成存储即可
  ![](http://oih7sazbd.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171026110449.png)

  3. 打开fiddler
  ![](http://oih7sazbd.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20171026110650.png)

  4. 打开APP,进入要抓取的界面
  ![](http://oih7sazbd.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171026105612.png)

  5. 点击请假后,从fiddler左侧的列表页面找到请求,获取这个请求的所有参数

  **request**
  ```
  URL: leaveinfoManage_listLeaveinfo.do?method=addLeaveinfoMobileV32
  param:
  auth: A6DBCA39D1B3F5FCB56465C5B89990DB
  disease: 2
  leaveType: 1
  roleid: 229
  reason: 老婆怀孕
  stuid: 633072283
  title:
  startTime: 2017-10-26 10:30:00
  endTime: 2017-10-30 10:32:00
  ```
  **response**
  ```
  {
    "Version": "1.0",
    "Charset": "UTF-8",
    "auth": "auth",
    "saltkey": "342807",
    "sid": "41",
    "userid": "855908485",
    "error": "success"
 }
  ```

### 批假
  1. 获取参数
  ```java
  String id = request.getParameter("id");
  String auth = request.getParameter("auth");
  String status = request.getParameter("status");
  String replyMess = request.getParameter("replyMsg"); // 驳回消息
  ```

  2. 获取请假角色对应的审核模板
  ```java
  Integer userId = leaveinfo.getOperator();
  TUsertable currUser = (TUsertable) leaveinfoManageService.getObject(new TUsertable(), userId);
  String roleId = currUser.getRoleid();
  if(roleId == null || "".equals(roleId))
  roleId = leaveinfoManageService.getCurrRoleIdByUserId(userId);
  String censor = this.getCensor(roleId);
  ```

  3. 解析审核模板,处理当前已审批数据
  ```java
  JSONArray censorArray = new JSONArray(censor);
  int censorSize = censorArray.length(); // 总的分级审核层数
  int censorCount = 0; // 需审核次数
  int[] days = new int[5];
  // 计算请假天数
  long milliSecond = leaveinfo.getEndTime().getTime() - leaveinfo.getStartTime().getTime();
  long day = milliSecond / (24 * 60 * 60 * 1000);
  long hour = (milliSecond % (24 * 60 * 60 * 1000)) / (1000 * 60 * 60);
  double lDays = day + (hour >= 8 ? 1 : (hour / 10.0));
  // 获取需审核次数
  for(int i = 0; i < censorSize; i++)
    days[i] = censorArray.getJSONObject(i).getInt("days");
  for(int i = 0; i < days.length; i++)
    if(lDays > days[i] && days[i] != 0)
      censorCount++;
    else if(days[i] != 0 && lDays <= days[i]){
      censorCount++;
      break;
    }
  // 获取已审核次数
  String approverStr = leaveinfo.getApprover();
  int approverSize = 0;
  boolean flag = false;
  StringBuffer buf = new StringBuffer();
  JSONArray approverArray = null;
  JSONObject jsonObject = new JSONObject();
  jsonObject.put("approver", usertable.getUserid()); // 当前审批人信息
  jsonObject.put("result", getStatus(Integer.parseInt(leaveinfoForm.getStatus())));
  if(null != approverStr && !"".equals(approverStr)){
    approverArray = new JSONArray(approverStr);
    approverSize = approverArray.length();
    /* uncertain factors */
    JSONObject object = approverArray.getJSONObject(approverSize - 1);
    String result = null;
    try {
      result = object.getString("result");
    } catch (Exception e) { // 客户端进行过留言
      String replyMessage = object.getString("replyMessage");
        String replyMsgTime = object.getString("replyMsgTime");
        jsonObject.put("replyMessage", replyMessage);
        jsonObject.put("replyMsgTime", replyMsgTime);
        approverArray.remove(--approverSize);
    }
    if(leaveinfo.getStatus().equals("1") || leaveinfo.getStatus().equals("2")){ // 状态为通过/未通过时,默认为更改
      if(approverSize == censorCount || leaveinfo.getStatus().equals("2")){
        approverArray.remove(--approverSize);
        flag =  true;
      }
    }
    jsonObject.put("rejectmessage", status.equals("2") ? replyMess : ""); // 驳回时需要输入原因
    jsonObject.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
      approverArray.put(jsonObject);
  }else{ // first approval
    jsonObject.put("rejectMessage", replyMess == null ? "" : replyMess);
      jsonObject.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
  }
  buf.append(approverArray == null ? "[" + jsonObject + "]" : approverArray);
  ```
  
## 完
