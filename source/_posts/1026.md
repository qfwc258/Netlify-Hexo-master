public void updateLeaveinfoPermitMobileV32(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) throws Exception {
		String auth = request.getParameter("auth");
		String id = request.getParameter("id");
		String status = request.getParameter("status");
		String replyMess = request.getParameter("replyMsg"); // 驳回消息
		String type = "QJ";
		TUsertable usertable = null;
		// 信息推送处理 {
		Integer counts = 1;
		String message = "老师批假,请知悉";
		String appMessage = "您有新的请假需要进行审批,请知悉";
		List<TUsertable> approverList = null;
		List<TUsertable> lesttemp = new ArrayList<TUsertable>();
		PushtoListCommons plc = new PushtoListCommons();
		MySessionContext myc = MySessionContext.getInstance();
		HttpSession session = request.getSession(true);
		// 获取已登录用户
		if (session != null) {
			usertable = (TUsertable) session.getAttribute("loginUser");
		}
		String logretrun = UserInfo.getAddLeaveInfo().toString();
		if (usertable == null) {
			response.setContentType("text/html;charset=utf-8");
			PrintWriter out = response.getWriter();
			logretrun.replace("error_temp", "用户登录失效，请重新登录。");
			logretrun = logretrun.replace("error_temp", "用户登录失效，请重新登录。");
			logretrun = logretrun.replace("list_temp", "");
			out.write(logretrun);
			out.close();
		} else {
			LeaveinfoForm leaveinfoForm = (LeaveinfoForm) form;
			leaveinfoForm.setId(Integer.parseInt(id));
			leaveinfoForm.setStatus(status);
			leaveinfoForm.setTUsertable(usertable);
			// 获取请假详情
			leaveinfo = (Leaveinfo) this.leaveinfoManageService.getObject(new Leaveinfo(), leaveinfoForm.getId());
			// 审批教师请假
			if(leaveinfo.getTeacherid() != null && leaveinfo.getTeacherid() > 0){
				type = "JSQJ";
				leaveinfoForm.setType(type);
				//  获取解析请假审核字符串
				String censorGrade;
				try {
					censorGrade = censorManageService.getCenssorGradeStrByServiceCode(Constants.SERVICE_CODE_QJGL, leaveinfo.getSid());
					net.sf.json.JSONArray censorJson = net.sf.json.JSONArray.fromObject(censorGrade);
					// 总审核次数
		  			int censorSize = censorJson.size();
		  			// 需审核次数
		  			int censorCount = 0;
		  			int[] days = new int[5];
		  			// 计算请假天数
					long milliSecond = leaveinfo.getEndTime().getTime() - leaveinfo.getStartTime().getTime();
					long day = milliSecond / (24 * 60 * 60 * 1000);
					long hour = (milliSecond % (24 * 60 * 60 * 1000)) / (1000 * 60 * 60);
					double lDays = day + (hour >= 8 ? 1 : (hour / 10.0));
					for (int i = 0; i < censorSize; i++)  // 审批级别所对应天数
						days[i] = censorJson.getJSONObject(i).getInt("days");
					for (int i = 0; i < days.length; i++) // 应审核级别数
						if (lDays > days[i] && days[i] != 0)
							censorCount++;
						// new
						else if (days[i] != 0 && lDays <= days[i]) {
							censorCount++;
							break;
						}
		  			// 获取已审核次数
		  			String approverStr = leaveinfo.getApproverStr();
		  			int approverSize = 0;
		  			boolean flag = false;
		  			StringBuffer newSb = new StringBuffer();
		  			net.sf.json.JSONArray approverJson = null;
		  			net.sf.json.JSONObject jsonObject = new net.sf.json.JSONObject();
		  			jsonObject.put("approver",usertable.getUserid());
					jsonObject.put("result", getStatus(Integer.parseInt(leaveinfoForm.getStatus())));
//					jsonObject.put("replyMessage",leaveMsg); // 留言
//					jsonObject.put("approverTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
					// 非第一次 
		  			if(null != approverStr && !approverStr.equals("")){
		  				approverJson = net.sf.json.JSONArray.fromObject(approverStr);
		  				approverSize = approverJson.size();
		  				
		  				/* uncertain factors */
		  				net.sf.json.JSONObject object = approverJson.getJSONObject(approverSize - 1);
		  				String result = null;
		  				try {
							result = object.getString("result");
						} catch (Exception e) {
						} 
		  				if(result == null || result.equals("")){ // 进行过留言
		  					String replyMessage = object.getString("replyMessage");
		  					String replyMsgTime = object.getString("replyMsgTime");
		  					jsonObject.put("replyMessage", replyMessage);
		  					jsonObject.put("replyMsgTime", replyMsgTime);
		  					approverJson.remove(approverSize - 1);
		  					approverSize-=1;
		  				}
		  				/* / uncertain factors */
		  				
		  				// 状态为通过/未通过,默认为更改
		  				if(leaveinfo.getStatus().equals("1") || leaveinfo.getStatus().equals("2")){
			  				// 状态为未通过或已审核数等同于应审核数,删除最后一次审核
			  				if(approverSize == censorCount || leaveinfo.getStatus().equals("2")){
			  					approverJson.remove(approverSize - 1);
			  					approverSize -= 1;
			  					flag = true;
			  				}
		  				}
		  				if(status.equals("2")){ // 驳回
	  						jsonObject.put("rejectMessage", replyMess);
		  				}else{
		  					jsonObject.put("rejectMessage", "");
		  				}
		  				jsonObject.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
				  		approverJson.add(jsonObject);
		  			}else{ // 第一次
		  				jsonObject.put("rejectMessage", replyMess == null ? "" : replyMess);
		  				jsonObject.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
		  			}
		  			newSb.append(approverJson == null ? "["+jsonObject+"]" : approverJson);
		  			// 是否已审核
		  			String usersId = censorJson.getJSONObject(approverSize).getString("usersId");
		  			String roleType=(String) request.getSession().getAttribute("roleType");
		  			// 获取请假人信息
		  			if(leaveinfo.getTeacherid() != 0 && leaveinfo.getStudentId() == 0)
		  				lesttemp = this.leaveinfoManageService.getUsertableByTeacheridNew(leaveinfo.getTeacherid());
		  			if(usersId.contains(usertable.getUserid().toString()) || (roleType != null &&(roleType.contains("S") || roleType.contains("M")))){
			  			// 如果状态为未通过或已是最后一次更改,则不替换approver
			  			if(leaveinfoForm.getStatus().equals("2") || (approverSize + 1) == censorCount){
			  				this.leaveinfoManageService.updateLeaveinfoPermit(leaveinfoForm.getStatus(),null,newSb.toString(),leaveinfo.getId());
			  				// 审批结束后,更改阅读状态
			  				leaveinfoForm.setReadStatus(2);
			  				this.leaveinfoManageService.updateLeaveinfoReadStatusPermit(leaveinfoForm);
			  				// 请假流程结束,推送结果
			  				message = "您的请假已经审核完毕,请知悉";
			  			}
			  			else{
			  				// 替换应审核人
			  				String approver = censorJson.getJSONObject(approverSize+1).getString("usersId");
			  				if(leaveinfo.getStatus().equals("2"))
			  					this.leaveinfoManageService.updateLeaveinfoPermit("0",approver,newSb.toString(),leaveinfo.getId());
			  				else
			  					this.leaveinfoManageService.updateLeaveinfoPermit(null,approver,newSb.toString(),leaveinfo.getId());
			  				// 推送请假流程进度
			  				String[] approvers = approver.split(",");
			  				// 下一级审核人员
			  				approverList = new ArrayList<TUsertable>();
			  				for(String str : approvers){
			  					usertable = (TUsertable) userManageService.getObject(usertable,Integer.parseInt(str));
			  					approverList.add(usertable);
			  				}
			  				message = "您的请假有了新的进度,请知悉";
			  			}
					}else{ // 该角色无审批权限/该请假信息已被同级人员审核
						// 因需兼容老版本,所以当该用户无权审批或已被同级人员审批过,则默认采用老版本
						leaveinfo=this.leaveinfoManageService.updateLeaveinfoPermitMobile(leaveinfoForm, request);
						lesttemp = this.leaveinfoManageService.getUsertableByTeacherid(leaveinfo.getTeacherid());
						message = "你的请假申请已被审批,请知悉";
						// 审批结束后,更改阅读状态
						leaveinfoForm.setReadStatus(2);
						this.leaveinfoManageService.updateLeaveinfoReadStatusPermit(leaveinfoForm);
					}
				} catch (Exception e) {
					// 没有审批机制,采用老版本
					leaveinfo=this.leaveinfoManageService.updateLeaveinfoPermitMobile(leaveinfoForm, request);
					lesttemp = this.leaveinfoManageService.getUsertableByTeacherid(leaveinfo.getTeacherid());
					message = "你的请假申请已被审批,请知悉";
					// 审批结束后,更改阅读状态
					leaveinfoForm.setReadStatus(2);
					this.leaveinfoManageService.updateLeaveinfoReadStatusPermit(leaveinfoForm);
				}
			}else{
				lesttemp = this.leaveinfoManageService.getParentUserByStud(leaveinfo.getStudentId());
				message = "老师批假,请知悉";
				leaveinfoForm.setType(type);
				// 审批学生请假
				this.leaveinfoManageService.updateLeaveinfoPermit2(leaveinfoForm, request);
				// 审批结束后,更改阅读状态
				leaveinfoForm.setReadStatus(2);
  				this.leaveinfoManageService.updateLeaveinfoReadStatusPermit(leaveinfoForm);
  				//  更改审批状态
  				if(leaveinfo.getApproverStr() == null || leaveinfo.getApproverStr().equals("")){
  					net.sf.json.JSONObject object = new net.sf.json.JSONObject();
  					object.put("approver",usertable.getUserid());
					object.put("result", getStatus(Integer.parseInt(leaveinfoForm.getStatus())));
  					object.put("replyMessage", "");
  					object.put("replyMsgTime", "");
  					object.put("rejectMessage", replyMess == null ? "":replyMess);
  					object.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
  					leaveinfo.setApproverStr("["+object+"]");
  				}else{
  					net.sf.json.JSONArray array = net.sf.json.JSONArray.fromObject(leaveinfo.getApproverStr());
  					net.sf.json.JSONObject object = array.getJSONObject(0);
  					object.put("result", getStatus(Integer.parseInt(leaveinfoForm.getStatus())));
  					object.put("rejectMessage", replyMess == null ? "":replyMess);
  					object.put("rejectMsgTime", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
  					array.remove(0);
  					array.add(object);
  					leaveinfo.setApproverStr(new StringBuffer().append(array).toString());
  				}
  				this.leaveinfoManageService.updateLeaveMessageV32(leaveinfo);
			}
			Integer sid = usertable.getSid();
			response.setContentType("text/html;charset=utf-8");
			PrintWriter out = response.getWriter();
			logretrun = logretrun.replace("sesson_temp", auth);
			logretrun = logretrun.replace("saltkey_temp", StringUtil.getRandomSix());
			logretrun = logretrun.replace("sid_temp", sid + "");
			logretrun = logretrun.replace("userid_temp", usertable.getUserid() + "");
			logretrun = logretrun.replace("error_temp", "success");
			out.write(logretrun);
			out.close();
			// 信息推送处理 {
			try {
				plc.sendMessage(lesttemp, message, type, "您有一条新消息", counts);
				if(approverList != null && approverList.size() > 0)
					plc.sendMessage(approverList, appMessage, type, "您有一条新消息", counts);
			} catch (Exception e) {
				log.debug("推送信息出错");
				System.out.println("推送信息出错");
			}
		}
	}